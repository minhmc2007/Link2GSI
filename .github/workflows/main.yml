name: Link to GSI Generator

on:
  workflow_dispatch:
    inputs:
      firmware_link:
        description: 'Stock Firmware Link (Direct Download/Wget)'
        required: true
      rom_type:
        description: 'ROM Type'
        required: true
        type: choice
        options:
          - OneUI
          - Pixel
          - MIUIGeneric
          - HyperOS
          - HMD

jobs:
  Link2GSI:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false # We handle this manually

      - name: Fix Broken Submodule (Manual Clone)
        run: |
          rm -rf Tools/Firmware_extractor
          git clone https://github.com/erfanoabdi/Firmware_extractor.git Tools/Firmware_extractor

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unace unrar zip unzip p7zip-full p7zip-rar sharutils rar uudeview mpack arj cabextract rename liblzma-dev python3-pip brotli lz4 protobuf-compiler git gawk

      - name: Install Python Dependencies
        run: |
          pip3 install backports.lzma protobuf twrpdtgen extract-dtb pycryptodome

      - name: Prepare and Clean URL
        id: prep
        run: |
          LINK="${{ inputs.firmware_link }}"
          if [[ "$LINK" == *"google.com/url"* ]]; then
             LINK=$(echo "$LINK" | grep -oP 'q=\K[^&]*' | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))")
          fi
          echo "url=$LINK" >> $GITHUB_OUTPUT

      - name: Download Firmware
        id: download
        run: |
          wget -q -O firmware.zip "${{ steps.prep.outputs.url }}"
          if [ -f firmware.zip ]; then
            echo "Download Successful."
            du -h firmware.zip
          else
            echo "Download Failed."
            exit 1
          fi

      - name: Run LinkToGSI Script
        run: |
          chmod +x LinkToGSI.sh
          sudo bash LinkToGSI.sh "$(pwd)/firmware.zip" "${{ inputs.rom_type }}"

      - name: Compress GSI (with Fallback)
        run: |
          cd Output || exit 1
          
          # 1. Take ownership from root (Fixes Permission Denied)
          sudo chown -R $USER:$USER .
          
          echo "Attempting compression..."
          
          # 2. Compress with xz -4 (Safe for RAM)
          # '|| true' ensures the workflow doesn't stop if compression fails
          xz -4 -T0 -v *.img || true
          
          echo "Compression step done. Checking files..."
          ls -lh

      - name: Upload GSI Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: GSI-${{ inputs.rom_type }}-Build
          # 3. Wildcard matches .img (raw) OR .img.xz (compressed)
          path: |
            Output/*.img*
            Output/*.txt
            Output/*.log
