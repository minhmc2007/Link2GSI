name: Link to GSI Generator

on:
  workflow_dispatch:
    inputs:
      firmware_link:
        description: 'Stock Firmware Link (Direct Download/Wget)'
        required: true
      rom_type:
        description: 'ROM Type'
        required: true
        type: choice
        options:
          - OneUI
          - Pixel
          - MIUIGeneric
          - HyperOS
          - HMD

jobs:
  Link2GSI:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false # We handle this manually to prevent errors

      - name: Fix Broken Submodule (Manual Clone)
        run: |
          rm -rf Tools/Firmware_extractor
          git clone https://github.com/erfanoabdi/Firmware_extractor.git Tools/Firmware_extractor

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unace unrar zip unzip p7zip-full p7zip-rar sharutils rar uudeview mpack arj cabextract rename liblzma-dev python3-pip brotli lz4 protobuf-compiler git gawk

      - name: Install Python Dependencies
        run: |
          pip3 install backports.lzma protobuf twrpdtgen extract-dtb pycryptodome

      - name: Prepare and Clean URL
        id: prep
        run: |
          LINK="${{ inputs.firmware_link }}"
          
          # Handle Google Redirect URLs
          if [[ "$LINK" == *"google.com/url"* ]]; then
             echo "Detected Google Redirect URL. Cleaning..."
             LINK=$(echo "$LINK" | grep -oP 'q=\K[^&]*' | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))")
          fi
          
          echo "Clean Link: $LINK"
          echo "url=$LINK" >> $GITHUB_OUTPUT

      - name: Download Firmware
        id: download
        run: |
          echo "Downloading Firmware..."
          # -q = Quiet, -O = Output filename
          wget -q -O firmware.zip "${{ steps.prep.outputs.url }}"
          
          if [ -f firmware.zip ]; then
            echo "Download Successful."
            du -h firmware.zip
          else
            echo "Download Failed."
            exit 1
          fi

      - name: Run LinkToGSI Script
        run: |
          chmod +x LinkToGSI.sh
          
          # Run the script using the downloaded local file
          # We pass "$(pwd)/firmware.zip" as the first argument
          sudo bash LinkToGSI.sh "$(pwd)/firmware.zip" "${{ inputs.rom_type }}"

      - name: Compress GSI
        run: |
          # Go into the Output folder (Capital 'O' matches your logs)
          cd Output || exit 1
          
          echo "Compressing GSI to save space..."
          # Compress the .img file using xz
          # -9 = Max compression, -T0 = Use all cores, -v = verbose
          xz -9 -T0 -v *.img

      - name: Upload GSI Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: GSI-${{ inputs.rom_type }}-Build
          path: |
            Output/*.img.xz
            Output/*.txt
            Output/*.log
