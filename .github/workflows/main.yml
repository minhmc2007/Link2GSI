name: Link to GSI Generator

on:
  workflow_dispatch:
    inputs:
      firmware_link:
        description: 'Stock Firmware Link (Direct Download/Wget)'
        required: true
      rom_type:
        description: 'ROM Type'
        required: true
        type: choice
        options:
          - OneUI
          - Pixel
          - MIUIGeneric
          - HyperOS
          - HMD

jobs:
  Link2GSI:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive  # <--- FIX: Clones the submodules (Tools/Firmware_extractor)
          fetch-depth: 0         # <--- FIX: Fetches full history so git commands work

      - name: Fix Git Config
        run: |
          # Sometimes needed if the script checks git user identity
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unace unrar zip unzip p7zip-full p7zip-rar sharutils rar uudeview mpack arj cabextract rename liblzma-dev python3-pip brotli lz4 protobuf-compiler git gawk

      - name: Install Python Dependencies
        run: |
          pip3 install backports.lzma protobuf twrpdtgen extract-dtb pycryptodome

      - name: Clean URL and Run LinkToGSI
        run: |
          # 1. Input Sanity Check
          LINK="${{ inputs.firmware_link }}"
          TYPE="${{ inputs.rom_type }}"
          
          # Attempt to extract real link if a Google redirect is pasted accidentally
          if [[ "$LINK" == *"google.com/url"* ]]; then
             echo "Detected Google Redirect URL. Attempting to extract real link..."
             LINK=$(echo "$LINK" | grep -oP 'q=\K[^&]*' | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))")
             echo "Cleaned Link: $LINK"
          fi

          # 2. Make executable
          chmod +x LinkToGSI.sh
          
          # 3. Run
          sudo bash LinkToGSI.sh "$LINK" "$TYPE"

      - name: Upload GSI Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: GSI-Build-Output-${{ inputs.rom_type }}
          path: |
            *.img
            *.zip
            *.txt
            output/*
            !src/
            !.git/
